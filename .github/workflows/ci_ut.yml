jobs:
  unit-test:
    name: Unit Test
    runs-on: self-hosted
    steps:
    - continue-on-error: true
      name: Checkout
      uses: actions/checkout@v3
    - continue-on-error: true
      name: Set up JDK
      uses: actions/setup-java@v3
      with:
        distribution: adopt
        java-version: 8
    - continue-on-error: true
      name: Cache Maven packages
      uses: actions/cache@v3
      with:
        key: ${{ runner.os }}-inlong-ut-${{ hashFiles('**/pom.xml') }}
        path: '~/.m2/repository

          !~/.m2/repository/org/apache/inlong

          '
        restore-keys: ${{ runner.os }}-inlong-ut
    - continue-on-error: true
      name: Set up swapfile path
      run: 'sudo sysctl -w vm.max_map_count=262144

        sudo sysctl -w fs.file-max=65536

        sudo fallocate -l 5G /swapfile

        sudo chmod 600 /swapfile

        sudo mkswap /swapfile

        sudo swapon /swapfile

        '
    - continue-on-error: true
      name: Remove unnecessary packages
      run: 'echo "=== Before pruning ==="

        df -h

        sudo rm -rf /usr/share/dotnet

        sudo rm -rf /usr/local/lib/android

        sudo rm -rf /opt/ghc

        echo

        echo "=== After pruning ==="

        df -h

        '
    - continue-on-error: true
      env:
        CI: false
      name: Build with Maven
      run: mvn --batch-mode --update-snapshots -e -V clean install -DskipTests -Dhttp.keepAlive=false
        -Dmaven.wagon.http.pool=false -Dmaven.wagon.httpconnectionManager.ttlSeconds=120
        -Daether.connector.http.reuseConnections=false -Daether.connector.requestTimeout=60000
    - continue-on-error: true
      env:
        CI: false
      name: Unit test with Maven
      run: mvn --batch-mode --update-snapshots -e -V test -pl !:sort-end-to-end-tests-v1.15,!:sort-end-to-end-tests-v1.13
    - continue-on-error: true
      if: ${{ failure() }}
      name: Upload unit test results
      uses: actions/upload-artifact@v3
      with:
        if-no-files-found: ignore
        name: surefire-reports
        path: ./**/target/surefire-reports/
    - continue-on-error: true
      if: ${{ failure() }}
      name: Upload integration test results
      uses: actions/upload-artifact@v3
      with:
        if-no-files-found: ignore
        name: failsafe-reports
        path: ./**/target/failsafe-reports/
    - continue-on-error: true
      name: Clean up build packages
      run: mvn clean
name: InLong Unit Test
on:
  repository_dispatch:
    types: trigger-ga___ci_ut.yml
